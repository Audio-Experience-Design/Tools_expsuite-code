Option Strict On
Option Explicit On
#Region "ExpSuite License"
'ExpSuite - software framework for applications to perform experiments (related but not limited to psychoacoustics).
'Copyright (C) 2003-2021 Acoustics Research Institute - Austrian Academy of Sciences; Piotr Majdak and Michael Mihocic
'Licensed under the EUPL, Version 1.2 or – as soon they will be approved by the European Commission - subsequent versions of the EUPL (the "Licence")
'You may not use this work except in compliance with the Licence. 
'You may obtain a copy of the Licence at: http://joinup.ec.europa.eu/software/page/eupl
'Unless required by applicable law or agreed to in writing, software distributed under the Licence is distributed on an "AS IS" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
'See the Licence for the specific language governing  permissions and limitations under the Licence. 
#End Region
''' <summary>
''' FrameWork - Tracker support.
''' </summary>
''' <remarks></remarks>
Module Tracker
    ''' <summary>
    ''' Experimental response from (Oculus) Tracker.
    ''' </summary>
    ''' <remarks><li>-1: no response</li>
    ''' <li>other values: see key handling from ExpSuite</li></remarks>
    Public glTrackerTriggerResponse As Integer = -1

    Private mblnSimulation As Boolean
    Private mlSensorCount As Integer
    Private mlSensorRequest As Integer

    ''' <summary>
    ''' Tracker Sensor data.
    ''' </summary>
    ''' <remarks></remarks>
    Public Structure TrackerSensor
        ''' <summary>
        ''' X position in cm
        ''' </summary>
        ''' <remarks></remarks>
        Dim sngX As Double
        ''' <summary>
        ''' Y position in cm
        ''' </summary>
        ''' <remarks></remarks>
        Dim sngY As Double
        ''' <summary>
        ''' Z position in cm
        ''' </summary>
        ''' <remarks></remarks>
        Dim sngZ As Double
        ''' <summary>
        ''' Azimuth angle in degrees
        ''' </summary>
        ''' <remarks></remarks>
        Dim sngA As Double
        ''' <summary>
        ''' Elevation angle in degrees
        ''' </summary>
        ''' <remarks></remarks>
        Dim sngE As Double
        ''' <summary>
        ''' Roll in degrees
        ''' </summary>
        ''' <remarks></remarks>
        Dim sngR As Double
        ''' <summary>
        ''' TRUE if the values are valid
        ''' </summary>
        ''' <remarks></remarks>
        Dim blnValid As Boolean
        ''' <summary>
        ''' Status of the sensor (used dependent on the data)
        ''' </summary>
        ''' <remarks></remarks>
        Dim lStatus As Integer
    End Structure

    Private mtsData(13) As TrackerSensor ' max. 14 sensors
    Private mlMinTracked() As Integer
    Private mlMinStatus() As Integer
    Private mlInRange() As Integer
    Private mlMaxTracked() As Integer
    Private mlMaxStatus() As Integer

    Private mcurTic As Long
    Private mlSensor As Integer
    Private mszDim As String

    Public Function Init(ByVal lCOM As Integer, ByVal lBaudRate As Integer, ByVal lSensorCount As Integer, ByVal blnSimulation As Boolean, ByVal lRepRate As Integer, ByVal sngPosScaling As Double) As String

        Dim lTO As Integer
        Dim curToc, curTicc As Long

        mblnSimulation = blnSimulation
        mlSensorCount = lSensorCount
        ReDim mlMinTracked(lSensorCount - 1)
        ReDim mlMaxTracked(lSensorCount - 1)
        ReDim mlMinStatus(lSensorCount - 1)
        ReDim mlMaxStatus(lSensorCount - 1)
        ReDim mlInRange(lSensorCount - 1)

        If glTrackerMode = 2 Then
            ' Tracker expected in ViWo (Unity)
            frmMain.SetStatus("Init Tracker: Expected in ViWo")
            Return ""
        Else
            ' Tracker expected in the Output device (YAMI)   
            frmMain.SetStatus("Init Tracker: Expected in YAMI")

            ' abstraction "tracker" laden
            Output.Send("/Tracker/Load")
            QueryPerformanceCounter(mcurTic)
            mcurTic = mcurTic + CLng(0.3 * gcurHPFrequency)
            While (Not gblnCancel) And (curToc < mcurTic)
                Windows.Forms.Application.DoEvents()
                QueryPerformanceCounter(curToc)
            End While

            ' init serial port
            frmMain.SetStatus("Init serial port")
            Output.Send("/Tracker/InitCOM", CSng(lCOM - 1), CSng(lBaudRate))
            QueryPerformanceCounter(mcurTic)
            mcurTic = mcurTic + CLng(0.2 * gcurHPFrequency)
            While (Not gblnCancel) And (curToc < mcurTic)
                Windows.Forms.Application.DoEvents()
                QueryPerformanceCounter(curToc)
            End While
            ' init FoB
            frmMain.SetStatus("Get tracker status")
            Output.Send("/Tracker/Simulation", CSng(-1 * CInt(blnSimulation)))
            mlSensorRequest = 1
            Output.Send("/Tracker/GetFoBStatus")
            QueryPerformanceCounter(mcurTic)
            mcurTic = mcurTic + CLng(2 * gcurHPFrequency)
            While CBool(mlSensorRequest) And (Not gblnCancel) And (curToc < mcurTic)
                Windows.Forms.Application.DoEvents()
                QueryPerformanceCounter(curToc)
            End While
            If gblnCancel Then Return "Canceled"
            If curToc >= mcurTic Then Return "Time Out waiting for GetFoBStatus"
            If (mtsData(0).lStatus And 64) = 0 Then
                ' master not running - cold start with much delay
                frmMain.SetStatus("Tracker: Cold start")
                lTO = 15000
            ElseIf (mtsData(1).lStatus And 64) = 0 Then
                ' master: RUN, slave: NOT RUN;
                If lSensorCount = 1 Then
                    frmMain.SetStatus("Tracker: Master ready")
                    lTO = 2000
                Else
                    frmMain.SetStatus("Tracker: Master ready, waiting for Slave")
                    lTO = 5000
                End If
            Else
                ' master: RUN, slave: RUN
                If lSensorCount = 1 Then
                    frmMain.SetStatus("Tracker: Disconnecting Slave")
                    lTO = 5000
                Else
                    frmMain.SetStatus("Tracker: Master & Slave ready")
                    lTO = 2000
                End If
            End If
            mtsData(0).blnValid = False
            mtsData(1).blnValid = False

            QueryPerformanceCounter(mcurTic)
            mcurTic = mcurTic + CLng(0.2 * gcurHPFrequency)
            While (Not gblnCancel) And (curToc < mcurTic)
                Windows.Forms.Application.DoEvents()
                QueryPerformanceCounter(curToc)
            End While
            mlSensorRequest = 1
            Output.Send("/Tracker/InitFoB", CSng(lSensorCount), CSng(lTO), CSng(lRepRate), CSng(sngPosScaling))
            QueryPerformanceCounter(mcurTic)
            curTicc = mcurTic
            mcurTic = mcurTic + CLng(lTO * 1.5 * gcurHPFrequency / 1000) ' wait 50% longer than Tracker
            While CBool(mlSensorRequest) And (Not gblnCancel) And (curToc < mcurTic)
                Windows.Forms.Application.DoEvents()
                QueryPerformanceCounter(curToc)
                frmMain.SetProgressbar(CSng((curToc - curTicc) / (mcurTic - curTicc) * 100))
            End While
            If gblnCancel Then Return "Canceled"
            If mlSensorRequest > 0 Then Return "Time Out waiting for InitFoB"
            frmMain.SetProgressbar(0)

            mlSensorRequest = 0
            Return ""
        End If ' Tracker in Output

    End Function

    ''' <summary>
    ''' Set current tracker values.
    ''' </summary>
    ''' <param name="lS">Sensor index.</param>
    ''' <param name="sngX">X-value</param>
    ''' <param name="sngY">Y-value</param>
    ''' <param name="sngZ">Z-value</param>
    ''' <param name="sngA">A-value</param>
    ''' <param name="sngE">E-value</param>
    ''' <param name="sngR">R-value</param>
    ''' <returns>Error text if an error occures.</returns>
    ''' <remarks></remarks>
    Public Function SetCurrentValues(ByVal lS As Integer, ByVal sngX As Double, ByVal sngY As Double, ByVal sngZ As Double, ByVal sngA As Double, ByVal sngE As Double, ByVal sngR As Double) As String

        If lS >= mlSensorCount Then SetCurrentValues = "Sensor index out of bound." : Exit Function

        'If Not mblnSimulation Then
        If glTrackerMode = 2 Then
            ViWo.Send("/Tracker/SetCurrentValues/" & TStr(lS), sngX, sngY, sngZ, sngA, sngE, sngR)
        Else
            Output.Send("/Tracker/SetCurrentValues/" & TStr(lS), sngX, sngY, sngZ, sngA, sngE, sngR)
        End If
        'End If
        '  mtsData(lS).sngA = sngA
        '  mtsData(lS).sngE = sngE
        '  mtsData(lS).sngR = sngR
        '  mtsData(lS).sngX = sngX
        '  mtsData(lS).sngY = sngY
        '  mtsData(lS).sngZ = sngZ
        '  mtsData(lS).blnValid = True
        SetCurrentValues = ""
    End Function

    ''' <summary>
    ''' Set tracker offsets.
    ''' </summary>
    ''' <param name="lS">Sensor index.</param>
    ''' <param name="sngX">X-value</param>
    ''' <param name="sngY">Y-value</param>
    ''' <param name="sngZ">Z-value</param>
    ''' <param name="sngA">A-value</param>
    ''' <param name="sngE">E-value</param>
    ''' <param name="sngR">R-value</param>
    ''' <returns>Error text if an error occures.</returns>
    ''' <remarks></remarks>
    Public Function SetOffset(ByVal lS As Integer, ByVal sngX As Double, ByVal sngY As Double, ByVal sngZ As Double, ByVal sngA As Double, ByVal sngE As Double, ByVal sngR As Double) As String

        If lS >= mlSensorCount Then SetOffset = "Sensor index out of bound." : Exit Function
        If glTrackerMode = 2 Then
            ViWo.Send("/Tracker/SetOffset/" & TStr(lS), 0, sngY, 0, 0, 0, 0) 'only y (height) in Unity
        Else
            Output.Send("/Tracker/SetOffset/" & TStr(lS), sngX, sngY, sngZ, sngA, sngE, sngR)
        End If

        SetOffset = ""
    End Function

    ''' <summary>
    ''' Get Current Values of a sensor from tracker.
    ''' </summary>
    ''' <param name="lTO">Time Out in ms. Special cases: <li>lTo = 0: send request only, don't wait</li><li>lTo = -1: don't send request, get received values requested ages before.</li></param>
    ''' <param name="lS">Sensor index (0...first sensor)</param>
    ''' <param name="tsResult">Current values from tracker.</param>
    ''' <returns>Empty if no errors, error message otherwise.</returns>
    ''' <remarks></remarks>
    Public Function GetCurrentValues(ByVal lTO As Integer, ByVal lS As Integer, ByRef tsResult As TrackerSensor) As String
        Dim curToc, curTic As Long

        ' send request if lTo = 0 or positive
        If lTO >= 0 Or glTrackerMode = 2 Then
            mtsData(lS).blnValid = False
            If glTrackerMode = 2 Then
                ViWo.Send("/Tracker/GetCurrentValues/" & TStr(lS)) 'request current tracker values from ViWo (Unity)
            Else
                If lS >= mlSensorCount Then Return "Sensor index out of bound."
                mtsData(lS).blnValid = False
                Output.Send("/Tracker/GetCurrentValues/" & TStr(lS)) 'request current tracker values from FoB tracker
            End If
        End If

        ' wait for request only if lTo is positive
        If lTO <> 0 And lTO <> -1 Then
            gblnCancel = False
            QueryPerformanceCounter(curTic)
            curTic = curTic + CLng(System.Math.Abs(lTO) * gcurHPFrequency / 1000)
            While mtsData(lS).blnValid = False And (Not gblnCancel) And (curToc < curTic)
                Windows.Forms.Application.DoEvents()
                QueryPerformanceCounter(curToc)
            End While
            If gblnCancel Then Return "Canceled"
        End If

        If lTO <> 0 Then
            If mtsData(lS).blnValid = False Then Return "Time Out"
            tsResult = mtsData(lS)
        End If
        Return ""
    End Function

    ''' <summary>
    ''' Track Min or/and Max values of a sensor.
    ''' </summary>
    ''' <param name="lS">Sensor index (0...first sensor)</param>
    ''' <param name="tsMin">Minimum values for all dimensions. The .lStatus field must have a set bit for each tracker dimension (order from LSB to MSB.</param>
    ''' <param name="tsMax">Maximum values for all dimensions.</param>
    ''' <returns>Empty if no error, error message otherwise.</returns>
    ''' <remarks></remarks>
    Public Function TrackMinMaxValues(ByVal lS As Integer, ByRef tsMin As TrackerSensor, ByRef tsMax As TrackerSensor) As String

        mlMinStatus(lS) = 0
        mlMaxStatus(lS) = 0
        mlInRange(lS) = 0

        mlMinTracked(lS) = tsMin.lStatus
        mlMaxTracked(lS) = tsMin.lStatus

        Dim tsMinT, tsMaxT As TrackerSensor

        tsMinT = tsMin
        If (tsMin.lStatus And 1) = 0 Then tsMinT.sngX = -1234
        If (tsMin.lStatus And 2) = 0 Then tsMinT.sngY = -1234
        If (tsMin.lStatus And 4) = 0 Then tsMinT.sngZ = -1234
        If (tsMin.lStatus And 8) = 0 Then tsMinT.sngA = -1234
        If (tsMin.lStatus And 16) = 0 Then tsMinT.sngE = -1234
        If (tsMin.lStatus And 32) = 0 Then tsMinT.sngR = -1234

        tsMaxT = tsMax
        If (tsMax.lStatus And 1) = 0 Then tsMaxT.sngX = 1234
        If (tsMax.lStatus And 2) = 0 Then tsMaxT.sngY = 1234
        If (tsMax.lStatus And 4) = 0 Then tsMaxT.sngZ = 1234
        If (tsMax.lStatus And 8) = 0 Then tsMaxT.sngA = 1234
        If (tsMax.lStatus And 16) = 0 Then tsMaxT.sngE = 1234
        If (tsMax.lStatus And 32) = 0 Then tsMaxT.sngR = 1234
        If glTrackerMode = 2 Then
            ViWo.Send("/Tracker/TrackMinMaxValues/" & TStr(lS), tsMinT.sngX, tsMaxT.sngX, tsMinT.sngY, tsMaxT.sngY, tsMinT.sngZ, tsMaxT.sngZ, tsMinT.sngA, tsMaxT.sngA, tsMinT.sngE, tsMaxT.sngE, tsMinT.sngR, tsMaxT.sngR)
        Else
            Output.Send("/Tracker/TrackMinMaxValues/" & TStr(lS), tsMinT.sngX, tsMaxT.sngX, tsMinT.sngY, tsMaxT.sngY, tsMinT.sngZ, tsMaxT.sngZ, tsMinT.sngA, tsMaxT.sngA, tsMinT.sngE, tsMaxT.sngE, tsMinT.sngR, tsMaxT.sngR)
        End If
        TrackMinMaxValues = ""
    End Function

    ''' <summary>
    ''' Stops tracking the min/max values by tracker.
    ''' </summary>
    ''' <param name="lS">Sensor index (0...first sensor)</param>
    ''' <returns>Empty string if no error ocured.</returns>
    ''' <remarks></remarks>
    Public Function DontTrackMinMaxValues(ByVal lS As Integer) As String

        mlMinStatus(lS) = 0
        mlMaxStatus(lS) = 0
        mlInRange(lS) = 0
        mlMinTracked(lS) = 0
        mlMaxTracked(lS) = 0
        If glTrackerMode = 2 Then
            ViWo.Send("/Tracker/DontTrackMinMaxValues/" & TStr(lS))
        Else
            Output.Send("/Tracker/DontTrackMinMaxValues/" & TStr(lS))
        End If
        DontTrackMinMaxValues = ""
    End Function

    ''' <summary>
    ''' Check if a sensor exceeded the minimum limit.
    ''' </summary>
    ''' <param name="lS">Sensor index (0...first sensor)</param>
    ''' <param name="lStatus"></param>
    ''' <returns></returns>
    ''' <remarks>lStatus is a mask to check the requested dimension. Set to 63 to check all dimensions</remarks>
    Public Function CheckTrackedMinValue(ByVal lS As Integer, ByVal lStatus As Integer) As Integer
        Return mlMinStatus(lS) And mlMinTracked(lS) And lStatus
    End Function

    ''' <summary>
    ''' 
    ''' </summary>
    ''' <param name="lS">Sensor index (0...first sensor)</param>
    ''' <param name="lStatus"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function CheckTrackedMaxValue(ByVal lS As Integer, ByVal lStatus As Integer) As Integer
        Return mlMaxStatus(lS) And mlMaxTracked(lS) And lStatus
    End Function

    ''' <summary>
    ''' Check if the sensor is within range now
    ''' </summary>
    ''' <param name="lS">Sensor index (0...first sensor)</param>
    ''' <param name="lStatus"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function CheckTrackedInRange(ByVal lS As Integer, ByVal lStatus As Integer) As Integer
        Return mlInRange(lS) And lStatus
    End Function

    Public Function HandleResponse(ByVal szCmd As String, ByVal varArgs() As Object) As String
        Dim szErr, szFunc, szX As String
        Dim lX As Integer
        szFunc = ""
        szX = ""

        If gblnTrackerLog Then
            Dim csvX As New CSVParser
            If Not IsNothing(varArgs) Then
                For lX = 0 To varArgs.Length - 1
                    szX = szX & csvX.QuoteCell(varArgs(lX).ToString) & Chr(glCSVDelimiter)
                Next
            End If
            lX = FreeFile()
            On Error Resume Next
            FileOpen(lX, STIM.WorkDir & "\trackerlog.csv", OpenMode.Append)
            'Debug.Print #lX, csvX.QuoteCell(Date) + Chr(glCSVDelimiter) + _
            ''csvX.QuoteCell(Time) + Chr(glCSVDelimiter) + _
            ''szCmd + Chr(glCSVDelimiter) + _
            ''szX
            FileClose(lX)
            csvX = Nothing
            On Error GoTo 0
        End If

        OSC.SeparateCommand(szCmd, szFunc)

        Select Case szFunc
            Case "InitFoB"
                mlSensorRequest = 0
                'frmMain.SetStatus("Tracker: InitFoB received")
            Case "GetFoBStatus"
                'frmMain.SetStatus("Tracker: Status received")
                If varArgs.Length <> 14 Then Return "GetFoBStatus: Invalid number of arguments."
                For lX = 0 To UBound(mtsData)
                    mtsData(lX).lStatus = CInt(varArgs(lX))
                Next
                mlSensorRequest = 0
            Case "GetCurrentValues"
                If IsNumeric(szCmd) Then
                    lX = CInt(Val(szCmd))
                    If mtsData(lX).blnValid Then Return "GetCurrentValues: Sensor not requested."
                    If UBound(varArgs) <> 5 Then Return "GetCurrentValues: Invalid number of argunments."
                    mtsData(lX).sngX = Val(varArgs(0))
                    mtsData(lX).sngY = Val(varArgs(1))
                    mtsData(lX).sngZ = Val(varArgs(2))
                    mtsData(lX).sngA = Val(varArgs(3))
                    mtsData(lX).sngE = Val(varArgs(4))
                    mtsData(lX).sngR = Val(varArgs(5))
                    mtsData(lX).blnValid = True
                End If
            Case "TrackMinMaxValues"
                If IsNumeric(szCmd) Then
                    lX = CInt(Val(szCmd))
                    If lX > UBound(mlMinTracked) Then Return "TrackMinMaxValues: Invalid sensor index"
                    If UBound(varArgs) <> 0 Then Return "TrackMinMaxValues: Invalid number of argunments."
                    If varArgs(0).ToString = "Xmin" And ((mlMinTracked(lX) And 1) <> 0) Then mlMinStatus(lX) = mlMinStatus(lX) Or 1 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 0)) - CInt(2 ^ 0) : mlMaxStatus(lX) = CShort(mlMaxStatus(lX) Or CInt(2 ^ 0)) - CInt(2 ^ 0)
                    If varArgs(0).ToString = "Xmax" And ((mlMaxTracked(lX) And 1) <> 0) Then mlMaxStatus(lX) = mlMaxStatus(lX) Or 1 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 0)) - CInt(2 ^ 0) : mlMinStatus(lX) = CShort(mlMinStatus(lX) Or CInt(2 ^ 0)) - CInt(2 ^ 0)
                    If varArgs(0).ToString = "Xinrange" And ((mlMinTracked(lX) And 1) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 1
                    If varArgs(0).ToString = "Xinrange" And ((mlMaxTracked(lX) And 1) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 1
                    If varArgs(0).ToString = "Ymin" And ((mlMinTracked(lX) And 2) <> 0) Then mlMinStatus(lX) = mlMinStatus(lX) Or 2 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 1)) - CInt(2 ^ 1) : mlMaxStatus(lX) = CShort(mlMaxStatus(lX) Or CInt(2 ^ 1)) - CInt(2 ^ 1)
                    If varArgs(0).ToString = "Ymax" And ((mlMaxTracked(lX) And 2) <> 0) Then mlMaxStatus(lX) = mlMaxStatus(lX) Or 2 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 1)) - CInt(2 ^ 1) : mlMinStatus(lX) = CShort(mlMinStatus(lX) Or CInt(2 ^ 1)) - CInt(2 ^ 1)
                    If varArgs(0).ToString = "Yinrange" And ((mlMinTracked(lX) And 2) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 2
                    If varArgs(0).ToString = "Yinrange" And ((mlMaxTracked(lX) And 2) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 2
                    If varArgs(0).ToString = "Zmin" And ((mlMinTracked(lX) And 4) <> 0) Then mlMinStatus(lX) = mlMinStatus(lX) Or 4 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 2)) - CInt(2 ^ 2) : mlMaxStatus(lX) = CShort(mlMaxStatus(lX) Or CInt(2 ^ 2)) - CInt(2 ^ 2)
                    If varArgs(0).ToString = "Zmax" And ((mlMaxTracked(lX) And 4) <> 0) Then mlMaxStatus(lX) = mlMaxStatus(lX) Or 4 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 2)) - CInt(2 ^ 2) : mlMinStatus(lX) = CShort(mlMinStatus(lX) Or CInt(2 ^ 2)) - CInt(2 ^ 2)
                    If varArgs(0).ToString = "Zinrange" And ((mlMinTracked(lX) And 4) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 4
                    If varArgs(0).ToString = "Zinrange" And ((mlMaxTracked(lX) And 4) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 4
                    If varArgs(0).ToString = "Amin" And ((mlMinTracked(lX) And 8) <> 0) Then mlMinStatus(lX) = mlMinStatus(lX) Or 8 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 3)) - CInt(2 ^ 3) : mlMaxStatus(lX) = CShort(mlMaxStatus(lX) Or CInt(2 ^ 3)) - CInt(2 ^ 3)
                    If varArgs(0).ToString = "Amax" And ((mlMaxTracked(lX) And 8) <> 0) Then mlMaxStatus(lX) = mlMaxStatus(lX) Or 8 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 3)) - CInt(2 ^ 3) : mlMinStatus(lX) = CShort(mlMinStatus(lX) Or CInt(2 ^ 3)) - CInt(2 ^ 3)
                    If varArgs(0).ToString = "Ainrange" And ((mlMinTracked(lX) And 8) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 8
                    If varArgs(0).ToString = "Ainrange" And ((mlMaxTracked(lX) And 8) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 8
                    If varArgs(0).ToString = "Emin" And ((mlMinTracked(lX) And 16) <> 0) Then mlMinStatus(lX) = mlMinStatus(lX) Or 16 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 4)) - CInt(2 ^ 4) : mlMaxStatus(lX) = CShort(mlMaxStatus(lX) Or CInt(2 ^ 4)) - CInt(2 ^ 4)
                    If varArgs(0).ToString = "Emax" And ((mlMaxTracked(lX) And 16) <> 0) Then mlMaxStatus(lX) = mlMaxStatus(lX) Or 16 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 4)) - CInt(2 ^ 4) : mlMinStatus(lX) = CShort(mlMinStatus(lX) Or CInt(2 ^ 4)) - CInt(2 ^ 4)
                    If varArgs(0).ToString = "Einrange" And ((mlMinTracked(lX) And 16) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 16
                    If varArgs(0).ToString = "Einrange" And ((mlMaxTracked(lX) And 16) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 16
                    If varArgs(0).ToString = "Rmin" And ((mlMinTracked(lX) And 32) <> 0) Then mlMinStatus(lX) = mlMinStatus(lX) Or 32 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 5)) - CInt(2 ^ 5) : mlMaxStatus(lX) = CShort(mlMaxStatus(lX) Or CInt(2 ^ 5)) - CInt(2 ^ 5)
                    If varArgs(0).ToString = "Rmax" And ((mlMaxTracked(lX) And 32) <> 0) Then mlMaxStatus(lX) = mlMaxStatus(lX) Or 32 : mlInRange(lX) = CShort(mlInRange(lX) Or CInt(2 ^ 5)) - CInt(2 ^ 5) : mlMinStatus(lX) = CShort(mlMinStatus(lX) Or CInt(2 ^ 5)) - CInt(2 ^ 5)
                    If varArgs(0).ToString = "Rinrange" And ((mlMinTracked(lX) And 32) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 32
                    If varArgs(0).ToString = "Rinrange" And ((mlMaxTracked(lX) And 32) <> 0) Then mlInRange(lX) = mlInRange(lX) Or 32
                End If
            Case "GetResponse"
                glTrackerTriggerResponse = CInt(Val(szCmd))

            Case Else
                Return "Tracker: Unknown response."
        End Select
        Return ""
    End Function

    Public Sub SetRangeData(ByVal lS As Integer, ByVal szDim As String)
        ' used as interface between frmSettings and frmSettingsTrackRange
        mlSensor = lS
        mszDim = szDim
    End Sub

    Public Sub GetRangeData(ByRef lS As Integer, ByRef szDim As String)
        ' used as interface between frmSettings and frmSettingsTrackRange
        lS = mlSensor
        szDim = mszDim
    End Sub
End Module